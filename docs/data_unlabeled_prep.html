---

title: Title

keywords: fastai
sidebar: home_sidebar

summary: "summary"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: nbs/01_data_unlabeled_prep.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
    
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">fastai</span> <span class="k">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">fastai.vision</span> <span class="k">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="k">import</span> <span class="n">Path</span>
<span class="kn">import</span> <span class="nn">cv2</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span> <span class="c1"># im - np.arr(h,w,3), figsize - tuple(2)</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">im</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span> <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span> <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">FACE_PATH</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;C:</span><span class="se">\\</span><span class="s2">Users</span><span class="se">\\</span><span class="s2">domin</span><span class="se">\\</span><span class="s2">Documents</span><span class="se">\\</span><span class="s2">FACE DATASETS</span><span class="se">\\</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="n">OUT_DIR</span> <span class="o">=</span> <span class="n">FACE_PATH</span><span class="o">/</span><span class="s2">&quot;unlabeled&quot;</span><span class="o">/</span><span class="s2">&quot;images&quot;</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">save_image</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">im_name</span><span class="p">):</span>
    <span class="n">image</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">OUT_DIR</span><span class="o">/</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">im_name</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;.jpg&quot;</span><span class="p">))</span>
    
<span class="k">def</span> <span class="nf">save_cv2_image</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">im_name</span><span class="p">):</span>
    <span class="n">image</span> <span class="o">=</span> <span class="n">Image</span><span class="p">(</span><span class="n">tensor</span><span class="p">(</span><span class="n">im</span><span class="p">)</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">type</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span><span class="o">/</span><span class="mf">255.</span><span class="p">)</span>
    <span class="n">save_image</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">im_name</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">prepare_image</span><span class="p">(</span><span class="n">image</span><span class="p">):</span> <span class="c1"># fastai.vision.Image</span>
    <span class="n">im</span> <span class="o">=</span> <span class="p">(</span><span class="n">image2np</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">data</span><span class="p">)</span><span class="o">*</span><span class="mi">255</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
    <span class="k">while</span> <span class="n">im</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">200</span> <span class="ow">or</span> <span class="n">im</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">200</span><span class="p">:</span>
        <span class="n">im</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">dsize</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fx</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">fy</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">im</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">pad_bbox</span><span class="p">(</span><span class="n">bbox</span><span class="o">=</span><span class="p">[</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">20</span><span class="p">,</span><span class="mi">20</span><span class="p">],</span> <span class="n">pad</span><span class="o">=</span><span class="p">[</span><span class="o">.</span><span class="mi">35</span><span class="p">,</span><span class="o">.</span><span class="mi">5</span><span class="p">,</span><span class="o">.</span><span class="mi">4</span><span class="p">,</span><span class="o">.</span><span class="mi">5</span><span class="p">],</span> <span class="n">im_shape</span><span class="o">=</span><span class="p">[</span><span class="mi">100</span><span class="p">,</span><span class="mi">200</span><span class="p">,</span><span class="mi">3</span><span class="p">]):</span>
    <span class="n">t</span><span class="p">,</span><span class="n">l</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">r</span> <span class="o">=</span> <span class="n">bbox</span>
    <span class="n">h</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="n">b</span><span class="o">-</span><span class="n">t</span><span class="p">,</span> <span class="n">r</span><span class="o">-</span><span class="n">l</span>
    <span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pad</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">h</span><span class="p">,</span><span class="n">w</span><span class="p">,</span><span class="n">h</span><span class="p">,</span><span class="n">w</span><span class="p">]))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">t</span><span class="p">,</span><span class="n">l</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">bbox</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">p</span><span class="p">[</span><span class="mi">3</span><span class="p">]])</span>
    <span class="n">t</span><span class="p">,</span><span class="n">l</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">t</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">l</span><span class="p">)</span>
    <span class="n">b</span><span class="p">,</span><span class="n">r</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">im_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">b</span><span class="p">),</span> <span class="nb">min</span><span class="p">(</span><span class="n">im_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">r</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">t</span><span class="p">,</span><span class="n">l</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">r</span><span class="p">]</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">modify_and_save_image</span><span class="p">(</span><span class="n">im_path</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">data_name</span><span class="p">,</span> <span class="n">im_func</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">image</span> <span class="o">=</span> <span class="n">open_image</span><span class="p">(</span><span class="n">im_path</span><span class="p">)</span>
    <span class="n">im</span> <span class="o">=</span> <span class="n">prepare_image</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">im_func</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">im</span> <span class="o">=</span> <span class="n">im_func</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>
    <span class="n">faces</span> <span class="o">=</span> <span class="n">detect_faces</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">faces</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="k">return</span>
    <span class="n">save_cv2_image</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">data_name</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Caffe-Face-detection">Caffe Face detection<a class="anchor-link" href="#Caffe-Face-detection">&#182;</a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">net</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">dnn</span><span class="o">.</span><span class="n">readNetFromCaffe</span><span class="p">(</span><span class="s2">&quot;../models/deploy.prototxt.txt&quot;</span><span class="p">,</span> <span class="s2">&quot;../models/res10_300x300_ssd_iter_140000.caffemodel&quot;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">detect_faces</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">min_confidence</span><span class="o">=</span><span class="mf">0.5</span><span class="p">):</span>
<span class="c1">#     image = cv2.cvtColor(image, cv2.COLOR_RGB2BGR).astype(np.uint8)</span>
    <span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">w</span><span class="p">)</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">blob</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">dnn</span><span class="o">.</span><span class="n">blobFromImage</span><span class="p">(</span><span class="n">cv2</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="p">(</span><span class="mi">300</span><span class="p">,</span> <span class="mi">300</span><span class="p">)),</span> <span class="mf">1.0</span><span class="p">,</span> <span class="p">(</span><span class="mi">300</span><span class="p">,</span> <span class="mi">300</span><span class="p">),</span> <span class="p">(</span><span class="mf">104.0</span><span class="p">,</span> <span class="mf">177.0</span><span class="p">,</span> <span class="mf">123.0</span><span class="p">))</span>
    <span class="n">net</span><span class="o">.</span><span class="n">setInput</span><span class="p">(</span><span class="n">blob</span><span class="p">)</span>
    <span class="n">detections</span> <span class="o">=</span> <span class="n">net</span><span class="o">.</span><span class="n">forward</span><span class="p">()</span>
    <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">detections</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
        <span class="n">confidence</span> <span class="o">=</span> <span class="n">detections</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">confidence</span> <span class="o">&gt;</span> <span class="n">min_confidence</span><span class="p">:</span>
            <span class="n">box</span> <span class="o">=</span> <span class="n">detections</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="mi">3</span><span class="p">:</span><span class="mi">7</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">])</span>
            <span class="p">(</span><span class="n">startX</span><span class="p">,</span> <span class="n">startY</span><span class="p">,</span> <span class="n">endX</span><span class="p">,</span> <span class="n">endY</span><span class="p">)</span> <span class="o">=</span> <span class="n">box</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;int&quot;</span><span class="p">)</span>
            <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">confidence</span><span class="p">,</span> <span class="p">[</span><span class="n">startY</span><span class="p">,</span> <span class="n">startX</span><span class="p">,</span> <span class="n">endY</span><span class="p">,</span> <span class="n">endX</span><span class="p">]))</span>
    <span class="k">return</span> <span class="n">out</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Cascade-face-detection">Cascade face detection<a class="anchor-link" href="#Cascade-face-detection">&#182;</a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">cascade_detect_regions</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">cascade_classifier</span><span class="p">):</span>
    <span class="n">img_gray</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_RGB2GRAY</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
    <span class="n">img_gray</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">equalizeHist</span><span class="p">(</span><span class="n">img_gray</span><span class="p">)</span>
    <span class="n">regions</span> <span class="o">=</span> <span class="n">cascade_classifier</span><span class="o">.</span><span class="n">detectMultiScale</span><span class="p">(</span><span class="n">img_gray</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">[</span> <span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">l</span><span class="p">,</span><span class="n">t</span><span class="o">+</span><span class="n">h</span><span class="p">,</span><span class="n">l</span><span class="o">+</span><span class="n">w</span><span class="p">)</span> <span class="k">for</span> <span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="n">t</span><span class="p">,</span><span class="n">w</span><span class="p">,</span><span class="n">h</span><span class="p">)</span> <span class="ow">in</span> <span class="n">regions</span><span class="p">]</span> <span class="c1"># out: (t,l,b,r)</span>

<span class="n">face_cascade</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">CascadeClassifier</span><span class="p">()</span>
<span class="n">face_cascade</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">cv2</span><span class="o">.</span><span class="n">samples</span><span class="o">.</span><span class="n">findFile</span><span class="p">(</span><span class="s1">&#39;../haarcascades/haarcascade_frontalface_default.xml&#39;</span><span class="p">))</span>
<span class="n">detect_faces</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">img</span><span class="p">:</span> <span class="n">cascade_detect_regions</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">face_cascade</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="lfw">lfw<a class="anchor-link" href="#lfw">&#182;</a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">lfw_paths</span><span class="p">():</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">FACE_PATH</span><span class="o">/</span><span class="s2">&quot;LFW&quot;</span><span class="o">/</span><span class="s2">&quot;lfw&quot;</span>
    <span class="n">im_paths</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">cat_path</span> <span class="ow">in</span> <span class="n">path</span><span class="o">.</span><span class="n">iterdir</span><span class="p">():</span>
        <span class="n">cat_name</span> <span class="o">=</span> <span class="n">cat_path</span><span class="o">.</span><span class="n">stem</span>
        <span class="n">im_paths</span> <span class="o">+=</span> <span class="n">get_image_files</span><span class="p">(</span><span class="n">cat_path</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">im_paths</span>
<span class="nb">len</span><span class="p">(</span><span class="n">lfw_paths</span><span class="p">())</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">prep_image</span><span class="p">(</span><span class="n">im</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">cv2</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">dsize</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fx</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">fy</span><span class="o">=</span><span class="mf">1.5</span><span class="p">)</span>

<span class="n">_modify_and_save_images</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">modify_and_save_image</span><span class="p">,</span> <span class="n">data_name</span><span class="o">=</span><span class="s2">&quot;lfw&quot;</span><span class="p">,</span> <span class="n">im_func</span><span class="o">=</span><span class="n">prep_image</span><span class="p">)</span>
<span class="n">parallel</span><span class="p">(</span><span class="n">_modify_and_save_images</span><span class="p">,</span> <span class="n">lfw_paths</span><span class="p">(),</span> <span class="n">max_workers</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="sof">sof<a class="anchor-link" href="#sof">&#182;</a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">sof_paths</span><span class="p">():</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">FACE_PATH</span><span class="o">/</span><span class="s2">&quot;SOF&quot;</span><span class="o">/</span><span class="s2">&quot;original images&quot;</span>
    <span class="k">return</span> <span class="n">get_image_files</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
<span class="nb">len</span><span class="p">(</span><span class="n">sof_paths</span><span class="p">())</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">_modify_and_save_images</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">modify_and_save_image</span><span class="p">,</span> <span class="n">data_name</span><span class="o">=</span><span class="s2">&quot;sof&quot;</span><span class="p">)</span>
<span class="n">parallel</span><span class="p">(</span><span class="n">_modify_and_save_images</span><span class="p">,</span> <span class="n">sof_paths</span><span class="p">(),</span> <span class="n">max_workers</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="facescrub">facescrub<a class="anchor-link" href="#facescrub">&#182;</a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">path</span> <span class="o">=</span> <span class="n">FACE_PATH</span><span class="o">/</span><span class="s2">&quot;FACESCRUB&quot;</span>
<span class="n">actors_path</span> <span class="o">=</span> <span class="n">path</span><span class="o">/</span><span class="s2">&quot;facescrub_actors.txt&quot;</span>
<span class="n">actress_path</span> <span class="o">=</span> <span class="n">path</span><span class="o">/</span><span class="s2">&quot;facescrub_actresses.txt&quot;</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">readlines</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">p</span><span class="p">:</span> <span class="nb">open</span><span class="p">(</span><span class="n">p</span><span class="p">)</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
<span class="n">parseline</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">l</span><span class="p">:</span> <span class="n">l</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">global</span> <span class="n">errors</span>
<span class="n">errors</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">def</span> <span class="nf">download_image</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">4</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">errors</span>
    <span class="n">suffix</span> <span class="o">=</span> <span class="n">url</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">dest</span> <span class="o">=</span> <span class="n">dest</span><span class="o">/</span><span class="n">f</span><span class="s2">&quot;</span><span class="si">{i:08d}</span><span class="s2">.</span><span class="si">{suffix}</span><span class="s2">&quot;</span>
    <span class="k">try</span><span class="p">:</span> <span class="n">r</span> <span class="o">=</span> <span class="n">download_url</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">show_progress</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">,</span> <span class="n">retries</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">errors</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="c1">#print(f&quot;Error {url} {e}&quot;)</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">facescrub_download</span><span class="p">(</span><span class="n">max_workers</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">errors</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">FACE_PATH</span><span class="o">/</span><span class="s2">&quot;FACESCRUB&quot;</span>
    <span class="n">images_path</span> <span class="o">=</span> <span class="n">path</span><span class="o">/</span><span class="s2">&quot;images&quot;</span>
    <span class="n">actors_path</span> <span class="o">=</span> <span class="n">path</span><span class="o">/</span><span class="s2">&quot;facescrub_actors.txt&quot;</span>
    <span class="n">actress_path</span> <span class="o">=</span> <span class="n">path</span><span class="o">/</span><span class="s2">&quot;facescrub_actresses.txt&quot;</span>
    <span class="n">urls</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">txt_path</span> <span class="ow">in</span> <span class="p">[</span><span class="n">actors_path</span><span class="p">,</span> <span class="n">actress_path</span><span class="p">]:</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="n">parseline</span><span class="p">,</span> <span class="n">readlines</span><span class="p">(</span><span class="n">txt_path</span><span class="p">)[</span><span class="mi">1</span><span class="p">:])</span>
        <span class="n">urls</span> <span class="o">+=</span> <span class="p">[</span><span class="n">url</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">image_id</span><span class="p">,</span> <span class="n">face_id</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">bbox</span><span class="p">,</span> <span class="n">sha256</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">]</span>
    <span class="n">parallel</span><span class="p">(</span><span class="n">partial</span><span class="p">(</span><span class="n">download_image</span><span class="p">,</span> <span class="n">images_path</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">),</span> <span class="n">urls</span><span class="p">,</span> <span class="n">max_workers</span><span class="o">=</span><span class="n">max_workers</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;errors:&quot;</span><span class="p">,</span> <span class="n">errors</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">facescrub_download</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">facesrub_verify</span><span class="p">():</span> <span class="c1"># deletes broken images</span>
    <span class="n">images_path</span> <span class="o">=</span> <span class="n">path</span><span class="o">/</span><span class="s2">&quot;images&quot;</span>
    <span class="n">verify_images</span><span class="p">(</span><span class="n">images_path</span><span class="p">,</span> <span class="n">delete</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">max_workers</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">max_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">recurse</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="n">images_path</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">facesrub_verify</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="bio-id">bio id<a class="anchor-link" href="#bio-id">&#182;</a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">bioid_paths</span><span class="p">():</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">FACE_PATH</span><span class="o">/</span><span class="s2">&quot;BIOID&quot;</span><span class="o">/</span><span class="s2">&quot;images&quot;</span>
    <span class="k">return</span> <span class="n">get_image_files</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
<span class="nb">len</span><span class="p">(</span><span class="n">bioid_paths</span><span class="p">())</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">_modify_and_save_images</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">modify_and_save_image</span><span class="p">,</span> <span class="n">data_name</span><span class="o">=</span><span class="s2">&quot;bioid&quot;</span><span class="p">)</span>
<span class="n">parallel</span><span class="p">(</span><span class="n">_modify_and_save_images</span><span class="p">,</span> <span class="n">bioid_paths</span><span class="p">(),</span> <span class="n">max_workers</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="utk">utk<a class="anchor-link" href="#utk">&#182;</a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">utk_path</span><span class="p">():</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">FACE_PATH</span><span class="o">/</span><span class="s2">&quot;UTK_FACE&quot;</span>
    <span class="n">paths</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">_id</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">):</span>
        <span class="n">dir_path</span> <span class="o">=</span> <span class="n">path</span><span class="o">/</span><span class="p">(</span><span class="s2">&quot;part&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">_id</span><span class="p">))</span>
        <span class="n">paths</span> <span class="o">+=</span> <span class="n">get_image_files</span><span class="p">(</span><span class="n">dir_path</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">paths</span>
<span class="nb">len</span><span class="p">(</span><span class="n">utk_path</span><span class="p">())</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">_modify_and_save_images</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">modify_and_save_image</span><span class="p">,</span> <span class="n">data_name</span><span class="o">=</span><span class="s2">&quot;utk&quot;</span><span class="p">)</span>
<span class="n">parallel</span><span class="p">(</span><span class="n">_modify_and_save_images</span><span class="p">,</span> <span class="n">utk_path</span><span class="p">(),</span> <span class="n">max_workers</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="youtube">youtube<a class="anchor-link" href="#youtube">&#182;</a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">choice</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">arr</span><span class="p">,</span> <span class="n">num_items</span><span class="p">:</span> <span class="p">[</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_items</span><span class="p">)]</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">youtube_path</span><span class="p">():</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">FACE_PATH</span><span class="o">/</span><span class="s2">&quot;YOUTUBE&quot;</span><span class="o">/</span><span class="s2">&quot;frame_images_DB&quot;</span>
    <span class="n">paths</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">cat_path</span> <span class="ow">in</span> <span class="n">path</span><span class="o">.</span><span class="n">iterdir</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">cat_path</span><span class="o">.</span><span class="n">is_dir</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">video_path</span> <span class="ow">in</span> <span class="n">cat_path</span><span class="o">.</span><span class="n">iterdir</span><span class="p">():</span>
                <span class="n">paths</span> <span class="o">+=</span> <span class="n">choice</span><span class="p">([</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">video_path</span><span class="o">.</span><span class="n">iterdir</span><span class="p">()],</span> <span class="mi">3</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">paths</span>
<span class="nb">len</span><span class="p">(</span><span class="n">youtube_path</span><span class="p">())</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">_modify_and_save_images</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">modify_and_save_image</span><span class="p">,</span> <span class="n">data_name</span><span class="o">=</span><span class="s2">&quot;yt&quot;</span><span class="p">)</span>
<span class="n">parallel</span><span class="p">(</span><span class="n">_modify_and_save_images</span><span class="p">,</span> <span class="n">youtube_path</span><span class="p">(),</span> <span class="n">max_workers</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="imdb-+-wiki">imdb + wiki<a class="anchor-link" href="#imdb-+-wiki">&#182;</a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">imdb_path</span><span class="p">():</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">FACE_PATH</span><span class="o">/</span><span class="s2">&quot;IMDB_WIKI&quot;</span><span class="o">/</span><span class="s2">&quot;imdb_crop&quot;</span>
    <span class="k">return</span> <span class="n">get_image_files</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">recurse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nb">len</span><span class="p">(</span><span class="n">imdb_path</span><span class="p">())</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">wiki_path</span><span class="p">():</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">FACE_PATH</span><span class="o">/</span><span class="s2">&quot;IMDB_WIKI&quot;</span><span class="o">/</span><span class="s2">&quot;wiki_crop&quot;</span>
    <span class="k">return</span> <span class="n">get_image_files</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">recurse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nb">len</span><span class="p">(</span><span class="n">wiki_path</span><span class="p">())</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">_modify_and_save_images</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">modify_and_save_image</span><span class="p">,</span> <span class="n">data_name</span><span class="o">=</span><span class="s2">&quot;imdb&quot;</span><span class="p">)</span>
<span class="n">parallel</span><span class="p">(</span><span class="n">_modify_and_save_images</span><span class="p">,</span> <span class="n">imdb_path</span><span class="p">(),</span> <span class="n">max_workers</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">_modify_and_save_images</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">modify_and_save_image</span><span class="p">,</span> <span class="n">data_name</span><span class="o">=</span><span class="s2">&quot;wiki&quot;</span><span class="p">)</span>
<span class="n">parallel</span><span class="p">(</span><span class="n">_modify_and_save_images</span><span class="p">,</span> <span class="n">wiki_path</span><span class="p">(),</span> <span class="n">max_workers</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="create-images-txt">create images txt<a class="anchor-link" href="#create-images-txt">&#182;</a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">create_images_txt</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">FACE_PATH</span><span class="o">/</span><span class="s2">&quot;unlabeled&quot;</span><span class="o">/</span><span class="s2">&quot;images.txt&quot;</span><span class="p">):</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">path</span><span class="p">),</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">OUT_DIR</span><span class="o">.</span><span class="n">iterdir</span><span class="p">()</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">create_images_txt</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
</div>
 

